<div class="content container-fluid ps-0">
	<%= render "provider_source_components/top_buttons"%>
	<div class="row">
		<div class="col-lg-3">
			<%= render "provider_source_components/sub_navbar"%>
		</div>
		<div class="col-lg-9">
			<div class="row border border-4 p-3">
				<!-- start of form header -->
				<div class="col-lg-12 mb">
					<div class="d-flex gap-2">
						<span class="bg-medium-grey circle d-flex justify-content-center align-items-center" style="width: 40px;height: 40px;">
							<i class="bi bi-mortarboard-fill text-white" style="font-size: 25px;"></i>
						</span>
						<div class="d-flex flex-column">
							<label class="text-dark-grey">Healthcare Facility Affiliations</label>
							<small>Please fill out 	all required fields</small>
						</div>
					</div>
				</div>
				<%#= render partial: "provider_source_components/progress_bar", locals: {percent: (@provider.specialties_progress)}%>
				<% steps = [['AFFILIATION INFORMATION','active', custom_provider_source_path(page: 'affiliation_information'),'affiliation_info_progress']]%>

				<%= render partial: "provider_source_components/progress_bar", locals: { steps: steps }%>
				<%= render partial: "provider_source_components/form_wizard", locals: {steps: steps}%>
				<div class="col-lg-12 card py-3 my-3">
					<h4 class="fw-semibold text-secondary mb-3">Affiliation Information</h4>
					<div class="row mb-2">
						<div class="col-lg-12">
							<div class="d-flex justify-content-between">
								<label class="text-dark-grey">Do/Did you have hospital privileges? <span class="text-danger"> *</span></label>
								<div class="d-flex me-4 gap-2">
									<div class="gap-2">
										<input type="radio" name="has_hospital_privilege" class="radio-with-form" data-form='hospital_privileges' value="yes" checked='checked'>
										<span>YES</span>
									</div>	
									<div class="gap-2">
										<input type="radio" name="has_hospital_privilege" class="radio-with-form" data-form='hospital_privileges' value="no" >
										<span>NO</span>
									</div>
								</div>
							</div>	
						</div>	
					</div>	
					<div class="<%= toggle_hide_current_provider_source('has_hospital_privilege', @provider) %>" id="hospital_privileges">
						<div id="hp_privilege_container">
							<% @provider.hospital_privileges.each_with_index do |hp_privilege, index| %>
							<%= render partial: 'provider_source_components/hospital_privileges', locals: { index: index, privilege: hp_privilege } %>
							<% end %>
						</div>

						<!-- Template to clone -->
						<div id="hp_privilege_template" class="hp-privilege-entry d-none">
							<%= render partial: 'provider_source_components/hospital_privileges', locals: { index: 'REPLACE_INDEX', privilege: HospitalPrivilege.new } %>
						</div>

						<button type="button" class="btn btn-outline-primary mt-2" id="add_hp_privilege">
							<i class="bi bi-plus-circle me-1"></i> Add New
						</button>
					</div>
					<div class="row mt-3">
						<div class="col-lg-12">
							<div class="d-flex justify-content-between">
								<label class="text-dark-grey">Do you have an admitting arrangement? <span class="text-danger"> *</span></label>
								<div class="d-flex me-4 gap-2">
									<div class="gap-2">
										<input type="radio" name="has_admitting_arrangement" class="radio-with-form" data-form='admitting_arrangements' value="yes" checked='checked'>
										<span>YES</span>
									</div>	
									<div class="gap-2">
										<input type="radio" name="has_admitting_arrangement" class="radio-with-form" data-form='admitting_arrangements' value="no" >
										<span>NO</span>
									</div>
								</div>
							</div>	
						</div>	
						<div class="<%= toggle_hide_current_provider_source('has_admitting_arrangement', @provider) %>" id="admitting_arrangements">
							<div id="admitting_arrangements_container">
								<% @provider.admitting_arrangements.each_with_index do |admitting_arrangements, index| %>
								<%= render partial: 'provider_source_components/admitting_arrangements', locals: { index: index, admitting: admitting_arrangements } %>
								<% end %>
							</div>

							<!-- Template to clone -->
							<div id="admitting_arrangements_template" class="admitting-arrangements-entry d-none">
								<%= render partial: 'provider_source_components/admitting_arrangements', locals: { index: 'REPLACE_INDEX', admitting: AdmittingArrangement.new } %>
							</div>

							<button type="button" class="btn btn-outline-primary mt-2" id="add_admitting_arrangements">
								<i class="bi bi-plus-circle me-1"></i> Add New
							</button>
						</div>
					</div>

					<div class="row mb-3 mt-3">
						<div class="col-lg-12">
							<label class="text-dark-grey">Please explain why you do not have an admitting arrangement.</label>
							<textarea class="form-control border-dark" placeholder="2500 max characters" name="admitting_arrangement_comment" rows="8"></textarea>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
$(document).ready(function () {
  let index = $("#hp_privilege_container .hp-privilege-entry").length;
  let arrangIndex = $("#admitting_arrangements_container .admitting-arrangements-entry").length;
  const pendingRequests = {}; // Track pending AJAX by input name

  $("#add_hp_privilege").on("click", function () {
    let newEntry = $("#hp_privilege_template").clone();
    newEntry.removeClass("d-none").css("display", "block").removeAttr("id");

    // Clear all inputs and assign names with new index
    newEntry.find("input, select, textarea").each(function () {
      let oldName = $(this).attr("name");
      if (oldName) {
        let newName = oldName.replace(/\[REPLACE_INDEX\]/, `[${index}]`);
        $(this).attr("name", newName);
      }

      // Reset values
      if ($(this).is("select")) {
        $(this).val("");
      } else if ($(this).attr("type") === "checkbox" || $(this).attr("type") === "radio") {
        $(this).prop("checked", false);
      } else {
        $(this).val("");
      }
    });

    newEntry.attr("data-id", ""); // Reset ID
    newEntry.attr("data-saving", "false"); // Custom flag to avoid race conditions

    index++;
    $("#hp_privilege_container").append(newEntry);
  });

  $("#add_admitting_arrangements").on("click", function () {
    let newEntry = $("#admitting_arrangements_template").clone();
    newEntry.removeClass("d-none").css("display", "block").removeAttr("id");

    // Clear all inputs and assign names with new index
    newEntry.find("input, select, textarea").each(function () {
      let oldName = $(this).attr("name");
      if (oldName) {
        let newName = oldName.replace(/\[REPLACE_INDEX\]/, `[${index}]`);
        $(this).attr("name", newName);
      }

      // Reset values
      if ($(this).is("select")) {
        $(this).val("");
      } else if ($(this).attr("type") === "checkbox" || $(this).attr("type") === "radio") {
        $(this).prop("checked", false);
      } else {
        $(this).val("");
      }
    });

    newEntry.attr("data-id", ""); // Reset ID
    newEntry.attr("data-saving", "false"); // Custom flag to avoid race conditions

    index++;
    $("#admitting_arrangements_container").append(newEntry);
  });

  $(document).on("click", ".remove_hp_privilege", function () {
    let entry = $(this).closest(".hp-privilege-entry");
    let privilege_id = entry.data("id");

    entry.remove();

    if (privilege_id) {
      $.ajax({
        url: `/provider_sources/autosave`,
        type: "POST",
        dataType: "json",
        data: { delete_privilege_id: privilege_id },
        headers: {
          "X-CSRF-Token": $("meta[name='csrf-token']").attr("content")
        },
        success: function () {
          console.log("Undergraduate School entry deleted.");
        },
        error: function (xhr, status, error) {
          console.error("Delete failed:", error);
        }
      });
    }
  });

  $(document).on("click", ".remove_admitting_arrangements", function () {
    let entry = $(this).closest(".admitting-arrangements-entry");
    let admitting_id = entry.data("id");

    entry.remove();

    if (admitting_id) {
      $.ajax({
        url: `/provider_sources/autosave`,
        type: "POST",
        dataType: "json",
        data: { delete_admitting_id: admitting_id },
        headers: {
          "X-CSRF-Token": $("meta[name='csrf-token']").attr("content")
        },
        success: function () {
          console.log("Undergraduate School entry deleted.");
        },
        error: function (xhr, status, error) {
          console.error("Delete failed:", error);
        }
      });
    }
  });

  // Debounce logic
  let debounceTimeout;
  $(document).on("change", "#hp_privilege_container input, #hp_privilege_container select, #hp_privilege_container textarea", function () {
    const $field = $(this);
    const fieldName = $field.attr("name");
    const value = $field.val();
    const $entry = $field.closest(".hp-privilege-entry");
    const $container = $("#hp_privilege_container");

    clearTimeout(debounceTimeout);

    debounceTimeout = setTimeout(function () {
      // Prevent duplicate autosave if already pending for this field
      if (pendingRequests[fieldName]) {
        return;
      }

      pendingRequests[fieldName] = true;
      $.ajax({
        url: "/provider_sources/autosave",
        type: "POST",
        dataType: "json",
        data: {
          field_name: fieldName,
          value: value,
          privilege_id: $entry[0].dataset.id,
          nested_form: true
        },
        headers: {
          "X-CSRF-Token": $("meta[name='csrf-token']").attr("content")
        },
        success: function (response) {
          if (response.id) {
            $entry.attr("data-id", response.id);
          }
        },
        complete: function () {
          pendingRequests[fieldName] = false;
        },
        error: function (xhr, status, error) {
          console.error("Autosave failed:", error);
        }
      });
    }, 300); // Debounce delay (ms)
  });

  $(document).on("change", "#admitting_arrangements_container input, #admitting_arrangements_container select, #admitting_arrangements_container textarea", function () {
    const $field = $(this);
    const fieldName = $field.attr("name");
    const value = $field.val();
    const $entry = $field.closest(".admitting-arrangements-entry");
    const $container = $("#admitting_arrangements_container");

    clearTimeout(debounceTimeout);

    debounceTimeout = setTimeout(function () {
      // Prevent duplicate autosave if already pending for this field
      if (pendingRequests[fieldName]) {
        return;
      }

      pendingRequests[fieldName] = true;
      $.ajax({
        url: "/provider_sources/autosave",
        type: "POST",
        dataType: "json",
        data: {
          field_name: fieldName,
          value: value,
          admitting_id: $entry[0].dataset.id,
          nested_form: true
        },
        headers: {
          "X-CSRF-Token": $("meta[name='csrf-token']").attr("content")
        },
        success: function (response) {
          if (response.id) {
            $entry.attr("data-id", response.id);
          }
        },
        complete: function () {
          pendingRequests[fieldName] = false;
        },
        error: function (xhr, status, error) {
          console.error("Autosave failed:", error);
        }
      });
    }, 300); // Debounce delay (ms)
  });
});
</script>
