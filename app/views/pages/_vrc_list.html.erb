<%# names = ['Lindsay Bennet', 'Bose, Paul', 'Diaz, Fynn', 'Calibre, Reese'] %>

<div class="row mt-3 mb-2 px-6">
  <div class="col-lg-6">
    <h5>Search Result: <%= @provider_personal_informations.count %> records</h5>
  </div>
  <div class="col-lg-6 d-flex justify-content-end gap-2">
    <div>
      <%= form_with url: request.url, method: :get, html: { id: 'vrc-progress-status-form' } do |form| %>
        <div style="float: right;">
          <%= form.select :'vrc-progress-status', [["All", "all"], ["Completed", "completed"], ["Assigned", "assigned"], ["To Be Assigned", "to_be_assigned"]], { selected: params[:'vrc-progress-status'] }, { style: "padding:8px; background-color: #ddd; border: 0px; border-radius: 5px; margin-left: 4px;", onchange: 'this.form.submit();' } %>
        </div>
      <% end %>
    </div>
    <div>
      <a href="#" class="btn btn-sm btn-primary" id="downloadCsvButton">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px;height: 16px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
        </svg>
        <span>Download Documents</span>
      </a>
    </div>
  </div>
</div>

<div class="row mt-2">
	<div id="alert-notification" class="alert alert-danger text-white fs-4" style="background-color:#ff0000; display: none;" role="alert">
	   No provider selection is made. Please select provider(s).
  </div>
</div>

  <table class="table table-bordered practice-table mt-3">
    <thead>
      <tr>
        <th class="text-white">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="selectAllCheckbox">
          </div>
        </th>
        <th class="text-white" scope="col">Encompass ID</th>
        <th class="text-white" scope="col">ASSIGNED</th>
        <th class="text-white" scope="col">PROVIDER NAME</th>
        <th class="text-white">PROVIDER TYPE</th>
        <th class="text-white">CRED CYCLE</th>
        <th class="text-white">PSV COMPLETED DATE</th>
        <th class="text-white">REVIEW LEVEL</th>
        <th class="text-white">RECRED DUE DATE</th>
        <th class="text-white">REVIEW DATE</th>
        <th class="text-white">COMMITTEE DATE</th>
        <th class="text-white">STATUS</th>
      </tr>
    </thead>
      <tbody>
        <% if @provider_personal_informations.present? %>
          <% @provider_personal_informations.each do |provider_personal_information| %>
            <% provider_source = provider_personal_information.provider_source %>
            <% source_data = provider_source&.data&.index_by(&:data_key) || {} %>
            <tr>
              <td class="option form-check-input">
                <%= check_box_tag "selected_ids[]", provider_personal_information.id, nil, id: "selected_#{provider_personal_information.id}" %>
              </td>
              <td>
                <%= provider_personal_information&.caqh_provider_attest_id || provider_personal_information&.provider_attest_id %>
              </td>
              <td><%= provider_personal_information.verification_status %>
              </td>
              <td>
                <% if provider_personal_information.created_by != 'group-engage' %>
                  <%= link_to(
                    "#{provider_personal_information.fullname}, #{provider_personal_information.provider_type_provider_type_abbreviation}",
                    show_virtual_review_committee_path(provider_personal_information.id)
                  ) %>
                <% else %>
                  <%= link_to(
                    "#{provider_source.full_name}, #{provider_personal_information.provider_type_provider_type_abbreviation}",
                    show_virtual_review_committee_path(provider_personal_information.id)
                  ) %>
                <% end %>
              </td>
              <td><%= provider_personal_information.provider_type_provider_type_abbreviation %></td>
              <td>
                <%= provider_personal_information.cred_cycle %>
              </td>
              <td><%= provider_personal_information.attest_date&.strftime('%Y-%m-%d') %></td>
              <td><%= provider_personal_information.review_level %></td>
              <td><%= provider_personal_information.recred_due_date || "NA" %></td>
              <td><%= provider_personal_information.review_date || "NA" %></td>
              <td><%= provider_personal_information.committee_date || "NA" %></td>
              <td>
                <%#= vrc&.status %>
                 <% case provider_personal_information.progress_status %>
                  <% when "completed" %>
                    <span style="font-size: 10px;">Approved</span>
                  <% when "assigned", "to_be_assigned" %>
                    <span style="font-size: 10px;"><%#= vrc.progress_status.titleize %> Unapproved</span>
                <% else %>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
  </table>
  <!-- Below the table -->
	<%= form_with url: '/virtual_review_committee/update_review_committee_dates', method: :put, html: { id: 'review-committee-form-1' } do |form| %>
	    <%= hidden_field_tag 'selected_ids[]', '', id: 'selected-ids-input-form1' %>
			<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			    <div class="modal-dialog modal-dialog-centered" >
			        <div class="modal-content">
			            <div class="modal-header">
			              <h5 class="modal-title fs-4" id="exampleModalLabel">Assign Reviewer(s) and Date</h5>
			              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			            </div>
			            <div class="modal-body">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">
                      <label class="form-check-label" for="flexCheckDefault">
                        ASSIGN TO ALL
                      </label>
                    </div>
                    <hr>
  		              <div class="row">
                      <form>
                        <div class="col-lg-6 overflow-auto" style="max-height: 300px;">
                          <% @vrc_directors.each do |vrc_director| %>
                            <% if vrc_director.director? %>
                              <div class="m-3">
                                 <input type="checkbox" name="vrc_directors[]" value="<%= vrc_director.id %>">
                                 <p class="d-inline ms-2 text-dark"><%= vrc_director.full_name%></p>
                              </div>
                            <% end %>
                           <% end %>
                        </div>
                      </form>
                      <div class="col-lg-6 ">
                        <div class="mb-4">
                          <%= form.label :review_date, class: 'form-label' %>
                          <%= form.date_field :review_date, class: 'form-control', required: true %>
                        </div>
                       <div>
                            <%= form.label :committee_date, class: 'form-label' %>
                            <%= form.date_field :committee_date, class: 'form-control', required: true %>
                            <% unless params[:'vrc-progress-status'] == "assigned" || params[:'vrc-progress-status'] == "completed" %>
                              <%= form.text_field :progress_status, value: "assigned", class: 'form-control', style: 'display: none;' %>
                            <% end %>
                         </div>
                        </div>
                       </div>
                    </div>
                    <div class="modal-footer">
                      <%= form.submit 'Update', class: 'btn btn-primary', id:"update-btn" %>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
					    		</div>
					    	</div>
							  </div>     
			        </div>
			    </div>
			</div>
	<% end %>

	<div class="col-lg-12">
	  <div class="d-flex justify-content-between bg-medium-grey rounded align-items-center py-3">
	    <div class="page_info ms-3 text-black">
	      <%= page_entries_info @provider_personal_informations %>
	    </div>
	    <% if params[:per_page].present? %>
	      <%= will_paginate @provider_personal_informations, params: { per_page: @per_page }, renderer: WillPaginate::ActionView::BootstrapLinkRenderer %>
	    <% else %>
	      <%= will_paginate @provider_personal_informations, renderer: WillPaginate::ActionView::BootstrapLinkRenderer %>
	    <% end %>
	  </div>
	</div>

 <div class="d-flex mt-4 justify-content-end">
    <button type="button" class="btn btn-primary assign-btn" id="submit-button">
      Assign to Committee Members
    </button>
    <% if params[:'vrc-progress-status'] == "assigned" || params[:'vrc-progress-status'] == "completed"%>
	    <%= form_with url: '/virtual_review_committee/unassigned_records', method: :put, html: { id: 'review-committee-form-2' } do |form| %>
	            <%= hidden_field_tag 'selected_ids[]', '', id: 'selected-ids-input-form2' %>
	            <div class="mx-3">
	             <%= form.submit 'Unassign Providers', class: 'btn btn-primary', id:"unassign-btn" %>
	            </div>
	    <% end %>
    <% end %>
</div>

<script>
$(document).ready(function () {
  const $submitButton = $("#submit-button");
  const $checkboxes = $("input[name='selected_ids[]']");
  const modal = new bootstrap.Modal($("#exampleModal")[0]);  // Initialize the modal
  const $alertMessage = $("#alert-notification");
  const $selectedIdsInputForm1 = $("#selected-ids-input-form1");
  const $selectedIdsInputForm2 = $("#selected-ids-input-form2");
  const $unAssignBtn = $("#unassign-btn");

  // Event listener for checkbox change
  $checkboxes.on("change", function () {
    updateSelectedIds();
  });

  // Event listener for submit button click
  $submitButton.on("click", function (event) {
    // Update selected IDs and check if at least one checkbox is selected
    let atLeastOneCheckboxChecked = updateSelectedIds();

    if (!atLeastOneCheckboxChecked) {
      event.preventDefault();  // Prevent form submission

      // Show the alert message if no checkboxes are selected
      $alertMessage.show();

      // Scroll to the top of the page to ensure the user sees the alert
      $("html, body").animate({ scrollTop: 0 }, "slow");

      // Return early to avoid modal showing
      return false;  // Prevent modal from showing when no checkboxes are checked
    }

    // Only show the modal if at least one checkbox is selected
    $alertMessage.hide();
    modal.show(); // Manually show the modal
  });

  $unAssignBtn.on("click", function(event){
    // Update selected IDs and check if at least one checkbox is selected
    let atLeastOneCheckboxChecked = updateSelectedIds();

    if (!atLeastOneCheckboxChecked) {
      event.preventDefault();  // Prevent form submission

      // Show the alert message if no checkboxes are selected
      $alertMessage.show();

      // Scroll to the top of the page to ensure the user sees the alert
      $("html, body").animate({ scrollTop: 0 }, "slow");

      // Return early to avoid modal showing
      return false;  // Prevent modal from showing when no checkboxes are checked
    }
  });

  // Function to update the hidden input fields with selected IDs
  function updateSelectedIds() {
    let selectedIds = [];

    // Loop through checkboxes and collect selected IDs
    $checkboxes.each(function () {
      if ($(this).prop("checked")) {
        selectedIds.push($(this).val());
      }
    });

    // Update hidden form inputs with selected IDs
    $selectedIdsInputForm1.val(selectedIds.join(','));
    $selectedIdsInputForm2.val(selectedIds.join(','));

    // Return true if there is at least one selected checkbox, otherwise false
    return selectedIds.length > 0;
  }


  // Select All functionality
  $("#selectAllCheckbox").click(function () {
    const isChecked = $(this).is(":checked");
    $("input[name='selected_ids[]']").prop("checked", isChecked);
  });

  // Download button functionality
  $("#downloadCsvButton").click(function (e) {
    e.preventDefault(); // Prevent the default link behavior

    // Collect selected checkbox values
    let selectedIds = [];
    $("input[name='selected_ids[]']:checked").each(function () {
        selectedIds.push($(this).val());
    });

    // Construct the URL for the download action
    let baseUrl = "<%= download_clients_path(format: 'csv') %>";
    let url = baseUrl;

    if (selectedIds.length > 0) {
        // If selected IDs exist, append them as a query parameter
        url += "?selected_ids=" + selectedIds.join(",");
    }

    // Redirect the browser to the constructed URL to trigger the download
    window.location.href = url;

    // Uncheck all checkboxes after download
    $("input[name='selected_ids[]']").prop("checked", false);
    $("#selectAllCheckbox").prop("checked", false);
  });
});
</script>

