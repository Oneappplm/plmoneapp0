<div class="content container-fluid">
  <div class="row mb-4">
    <div class="col-lg-12 d-flex justify-content-end gap-2">
      <% if current_user.can_access?('Users') %>
        <a href="<%= users_path %>" class="btn btn-md border-0 px-5 <%= enrollment_nav_active('users') %>">Users</a>
      <% end %>
      <% if current_user.can_access?('Role Access') %>
        <a href="javascript:void(0);" class="btn btn-md border-0 <%= enrollment_nav_active('role_based_accesses') %>">Role Access</a>
      <% end %>
    </div>
  </div>
</div>

<%= render 'user_restriction', locals: { access_key: 'Role Access' } do %>
  <div class="container-fluid">
    <div class="row mb-3">
      <div class="col-lg-12">
        <h2>Role-Based Access</h2>
      </div>
    </div>

		<% if @role_based %>
			<div class="row">
				<div class="col-lg-12">
					<div class="card rounded shadow-lg p-3 mb-3">
						<%= render partial: "global_components/collapsible_sidebar_header_with_checkbox", locals: { title: 'Overview', collapse_name: 'role_access_overview'} %>
						<div class="collapsible" style="<%= can_view?('Overview', @role_based) ? '' : 'display: none;' %>">
						</div>
					</div>
					<div class="card rounded shadow-lg p-3 mb-3">
						<%= render partial: "global_components/collapsible_sidebar_header_with_checkbox", locals: { title: 'Dashboard', collapse_name: 'role_access_dashbord'} %>
						<div class="collapsible mt-3" style="<%= can_view?('Dashboard', @role_based) ? '' : 'display: none;' %> ">
							<div class="row">
								<div class="col-lg-4">
									<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
										<div class='row d-flex align-items-center padding-5'>
											<h5>
												<%= HtmlUtils.role_based_access_checkbox title: 'Data Access' %>
											</h5>
										</div>
									</div>
								</div>

								<div class="col-lg-4">
									<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
										<div class='row d-flex align-items-center padding-5'>
											<h5>
												<%= HtmlUtils.role_based_access_checkbox title: 'Decision Point' %>
											</h5>
										</div>
										<div class="padding-25">
											<div class="padding-5">
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Scheduler' %>
												</h5>
											</div>
											<div class="padding-5">
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Work Tickler' %>
												</h5>
											</div>
											<div class="padding-5">
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Documents' %>
												</h5>
											</div>
											<div class="padding-5">
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Reports' %>
												</h5>
											</div>
											<div class="padding-5">
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Minutes' %>
												</h5>
											</div>
											<div class="padding-5">
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Issue' %>
												</h5>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="card rounded shadow-lg p-3 mb-3">
						<%= render partial: "global_components/collapsible_sidebar_header_with_checkbox", locals: { title: 'Provider Engage', collapse_name: 'role_access_provider_engage'} %>
					</div>
					<div class="card rounded shadow-lg p-3 mb-3">
						<%= render partial: "global_components/collapsible_sidebar_header_with_checkbox", locals: { title: 'App Tracker', collapse_name: 'role_access_app_tracker'} %>
					</div>
					<div class="card rounded shadow-lg p-3 mb-3">
						<%= render partial: "global_components/collapsible_sidebar_header_with_checkbox", locals: { title: 'Group Engage', collapse_name: 'role_access_group_engage'} %>

        <% if current_user.can_access?('Delete Role') && @role_based.present? %>
          <% if current_user.can_access?('Delete Role') && @role_based.present? %>
            <%= link_to 'Delete Role', "javascript:void(0);", class: 'btn btn-danger text-white btn-sm', id: 'delete-role' %>
          <% end %>

        <% end %>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-7">
        <%= form_with url: role_based_accesses_path, method: :get, local: true, html: { class: 'd-flex gap-2' } do |form| %>
          <%= form.hidden_field :role_based, value: @role_based %>
          <%= form.text_field :query, value: params[:query], class: 'form-control', placeholder: 'Search Item...' %>
          <button class="btn btn-secondary">
            <i class="bi bi-search"></i>
          </button>
        <% end %>
      </div>
    </div>

    <div class="row">
      <div class="col-12 col-md-7">
        <%= form_with url: update_permissions_role_based_accesses_path, method: :post, local: true do %>
          <input type="hidden" name="role_based" value="<%= @role_based %>">

          <table class="table table-bordered text-center">
            <thead class="table-primary">
              <tr>
                <th class="bg-primary text-white">Configuration Item</th>
                <th class="bg-primary text-white">Full Access</th>
                <th class="bg-primary text-white">Read</th>
                <th class="bg-primary text-white">Write</th>
                <th class="bg-primary text-white">Create</th>
                <th class="bg-primary text-white">Delete</th>
              </tr>
            </thead>
            <tbody>
              <% @permissions.each do |page, accesses| %>
                <tr>
                  <td class="fw-bold"><%= page.titleize %></td>
                  <% accesses.each do |access| %>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][full_access]", "1",
                          (access.can_read && access.can_update && access.can_create && access.can_delete),
                          class: "full-access", data: { target_id: access.id } %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][read]", "1", access.can_read, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][write]", "1", access.can_update, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][create]", "1", access.can_create, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][delete]", "1", access.can_delete, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>

          <button type="submit" class="btn btn-primary mt-3">Save Changes</button>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<% content_for :js do %>
  <script>
    $(document).ready(function() {
      // When "Full Access" is changed, toggle all related permissions
      $(".full-access").on("change", function() {
        let targetId = $(this).data("target-id");
        let isChecked = $(this).prop("checked");

        $(".permission-" + targetId).prop("checked", isChecked).trigger("change");
      });

      // When any individual permission changes, update "Full Access"
      $(".permission-checkbox").on("change", function() {
        let targetId = $(this).closest("tr").find(".full-access").data("target-id");

        // Get all related permission checkboxes
        let permissionCheckboxes = $(".permission-" + targetId);
        let allChecked = permissionCheckboxes.length === permissionCheckboxes.filter(":checked").length;

        // If all permissions are checked, check "Full Access", otherwise uncheck it
        $(".full-access[data-target-id='" + targetId + "']").prop("checked", allChecked);
      });

      // Ensure "Full Access" updates correctly when form is submitted
      $("form").on("submit", function() {
        $(".full-access").each(function() {
          if (!$(this).prop("checked")) {
            // Add a hidden input to explicitly send unchecked value
            $(this).after(`<input type="hidden" name="${$(this).attr("name")}" value="0">`);
          }
        });
      });

      // Delete Role Button Logic
      $('#delete-role').on('click', function(){
        if (!confirm('Are you sure you want to delete this role?')) {
          return false;
        }

        var role_id = $('#role_based').val();
        var delete_url = "<%= delete_role_role_based_accesses_path %>";

        $.ajax({
          url: delete_url,
          type: 'post',
          data: { authenticity_token: $('meta[name="csrf-token"]').attr('content'), role: role_id },
          success: function(data) {
            window.location.href = "/role-based-access";
          },
          error: function(response) {
            alert(response.responseText);
          }
        });
      });
    });

  </script>
<% end %>
