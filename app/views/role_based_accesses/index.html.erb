<div class="content container-fluid">
  <div class="row mb-4">
    <div class="col-lg-12 d-flex justify-content-end gap-2">
      <% if current_user.can_access?('Users') %>
        <a href="<%= users_path %>" class="btn btn-md border-0 px-5 <%= enrollment_nav_active('users') %>">Users</a>
      <% end %>
      <% if current_user.can_access?('Role Access') %>
        <a href="javascript:void(0);" class="btn btn-md border-0 <%= enrollment_nav_active('role_based_accesses') %>">Role Access</a>
      <% end %>
    </div>
  </div>
</div>

<%= render 'user_restriction', locals: { access_key: 'Role Access' } do %>
  <div class="container-fluid">
    <div class="row mb-3">
      <div class="col-lg-12">
        <h2>Role-Based Access</h2>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-lg-6 d-flex gap-2">
        <%= form_with url: role_based_accesses_path, method: :get, local: true, html: { id: "role-form" } do |form| %>
          <%= form.select :role_based, options_for_select(current_user.allowed_roles, @role_based),
              { prompt: 'Select Role' },
              class: 'form-select',
              onchange: 'this.form.submit();' %>
        <% end %>

        <% if current_user.can_access?('Delete Role') && @role_based.present? %>
          <% if current_user.can_access?('Delete Role') && @role_based.present? %>
            <%= link_to 'Delete Role', "javascript:void(0);", class: 'btn btn-danger text-white btn-sm', id: 'delete-role' %>
          <% end %>

        <% end %>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-7">
        <%= form_with url: role_based_accesses_path, method: :get, local: true, html: { class: 'd-flex gap-2' } do |form| %>
          <%= form.hidden_field :role_based, value: @role_based %>
          <%= form.text_field :query, value: params[:query], class: 'form-control', placeholder: 'Search Item...' %>
          <button class="btn btn-secondary">
            <i class="bi bi-search"></i>
          </button>
        <% end %>
      </div>
    </div>

    <div class="row">
      <div class="col-12 col-md-7">
        <%= form_with url: update_permissions_role_based_accesses_path, method: :post, local: true do %>
          <input type="hidden" name="role_based" value="<%= @role_based %>">

          <table class="table table-bordered text-center">
            <thead class="table-primary">
              <tr>
                <th class="bg-primary text-white">Configuration Item</th>
                <th class="bg-primary text-white">Full Access</th>
                <th class="bg-primary text-white">Read</th>
                <th class="bg-primary text-white">Write</th>
                <th class="bg-primary text-white">Create</th>
                <th class="bg-primary text-white">Delete</th>
              </tr>
            </thead>
            <tbody>
              <% @permissions.each do |page, accesses| %>
                <tr>
                  <td class="fw-bold"><%= page.titleize %></td>
                  <% accesses.each do |access| %>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][full_access]", "1",
                          (access.can_read && access.can_update && access.can_create && access.can_delete),
                          class: "full-access", data: { target_id: access.id } %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][read]", "1", access.can_read, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][write]", "1", access.can_update, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][create]", "1", access.can_create, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                    <td>
                      <%= check_box_tag "permissions[#{access.id}][delete]", "1", access.can_delete, class: "permission-#{access.id} permission-checkbox" %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>

					<% unless current_setting.dcm? %>
						<div class="card rounded shadow-lg p-3 mb-3">
							<%= render partial: "global_components/collapsible_sidebar_header_with_checkbox", locals: { title: 'Verification Platform', collapse_name: 'role_access_verification_platform'} %>
							<div class="collapsible mt-3" style="<%= can_view?('Verification Platform', @role_based) ? '' : 'display: none;' %> ">
								<div class="row">
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Client Home' %>
												</h5>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Manage Client' %>
												</h5>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Manage Practitioner' %>
												</h5>
											</div>
										</div>
									</div>
								</div>
								<div class="mt-3 row">
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Manage Tools' %>
												</h5>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Query Report' %>
												</h5>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Work Tickler' %>
												</h5>
											</div>
										</div>
									</div>
								</div>
								<div class="mt-3 row">
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Manage DB' %>
												</h5>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="border rounded padding-10 h-100" style="border-width:2px!important;">
											<div class='row d-flex align-items-center padding-5'>
												<h5>
													<%= HtmlUtils.role_based_access_checkbox title: 'Autoverify' %>
												</h5>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					<% end %>
						
					<div class="card rounded shadow-lg p-3 mb-3">
						<%= render partial: "global_components/collapsible_sidebar_header_with_checkbox", locals: { title: 'App Tracker', collapse_name: 'role_access_app_tracker'} %>
					</div>
				</div>
			</div>
		<% end %>

	</div>
	<% content_for :js do %>
	<script>
		$(document).on('change', '.role-based-access', function() {
		var checkbox = $(this);
		var checkboxValue = checkbox.is(':checked');
			var attributeName = checkbox.attr('name')
			var roleId = checkbox.data('id');
			var update_url = "/role-based-access/"+roleId+"/update_access";
			var collapsible_link = $(this).parent().parent().find('a.collapsible-trigger');

			$.post(update_url, {authenticity_token: $('meta[name="csrf-token"]').attr('content'), attribute_name: attributeName, attribute_value: checkboxValue});

			// find closest anchor with class collapsible-trigger and click it
			// verify if collapsible_link exists
			if(collapsible_link.length > 0){
				collapsible_link.trigger('click');
			}

	});

	$('#role_based_can_read').on('change', function(){
	var isChecked = $(this).is(':checked');
	$('.can-read').prop('checked', isChecked);
		$('.can-read').trigger('change');
	});

	$('#role_based_can_create').on('change', function(){
	var isChecked = $(this).is(':checked');
	$('.can-create').prop('checked', isChecked);
		$('.can-create').trigger('change');
	});

	$('#role_based_can_update').on('change', function(){
	var isChecked = $(this).is(':checked');
	$('.can-update').prop('checked', isChecked);
		$('.can-update').trigger('change');
	});

	$('#role_based_can_delete').on('change', function(){
	var isChecked = $(this).is(':checked');
	$('.can-delete').prop('checked', isChecked);
		$('.can-delete').trigger('change');
	});

	$('#delete-role').on('click', function(){
		// add confirm first
		if(!confirm('Are you sure you want to delete this role?')){
			return false;
		}
		var role_id = $('#role_based').val();
		var delete_url = "<%= delete_role_role_based_accesses_path %>";

		$.ajax({
			url: delete_url,
			type: 'post',
			data: {authenticity_token: $('meta[name="csrf-token"]').attr('content'), role: role_id},
			success: function(data){
				window.location.href = "/role-based-access";
			},
			error: function(response){
				alert(response.responseText)
			}
		});

	});
	</script>
	<% end %>
<% end %>
