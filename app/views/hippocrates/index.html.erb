<div class="col-lg-10 mx-auto mt-5">
  <h2>Hippocrates Prompt</h2>

  <div id="hippocrates-prompt", class="input-group w-50">
    <input type="text" id="hippocrates-input" placeholder="Ask something...", class="form-control" />
    <button id="hippocrates-submit", class="btn btn-success">Submit</button>
  </div>

  <%= turbo_frame_tag "hippocrates-results" do %>
    <!-- Results will appear here -->
  <% end %>
</div>

<script>
  $(document).ready(function () {
    setupCSRFToken();
    bindPromptSubmit();
    bindLicenseDownload();
    bindSelectAllCheckbox();
  });

  // Set up CSRF token for all AJAX requests
  function setupCSRFToken() {
    const csrfToken = $('meta[name="csrf-token"]').attr('content');
    $.ajaxSetup({
      headers: {
        'X-CSRF-Token': csrfToken
      }
    });
  }

  // Handle prompt submission (e.g., "show me expired licenses")
  function bindPromptSubmit() {
    $("#hippocrates-submit").on("click", function () {
      const promptValue = $("#hippocrates-input").val().trim();

      if (!promptValue) {
        alert("Please enter a prompt.");
        return;
      }

      $.ajax({
        url: "/hippocrates/expired_licenses",
        type: "POST",
        data: { prompt: promptValue },
        dataType: "script",
        error: function (xhr) {
          alert("Something went wrong.");
          console.error(xhr.responseText);
        }
      });
    });
  }

  // Handle form submission for license download (single or multiple)
  function bindLicenseDownload() {
    $(document).on("submit", "#license-download-form", function (e) {
      e.preventDefault();

      const format = $("#bulk-download-format").val();
      if (!format) {
        alert("Please select a format.");
        return;
      }

      const selectedLicenses = $(".license-checkbox:checked").map(function () {
        return $(this).val();
      }).get();

      if (selectedLicenses.length === 0) {
        alert("Please select at least one license.");
        return;
      }

      if (selectedLicenses.length === 1) {
        // Single license → GET download
        const license = selectedLicenses[0];
        window.location.href = `/hippocrates/download_expired_license?license=${license}&format=${format}`;
      } else {
        // Multiple licenses → POST bulk download
        postBulkDownload(selectedLicenses, format);
      }

      resetDownloadForm();
    });
  }

  // Helper to build and submit hidden bulk download form
  function postBulkDownload(licenses, format) {
    const form = $("<form>", {
      method: "POST",
      action: "/hippocrates/bulk_download_expired_licenses",
      style: "display: none;"
    });

    const csrfToken = $('meta[name="csrf-token"]').attr('content');
    form.append($("<input>", {
      type: "hidden",
      name: "authenticity_token",
      value: csrfToken
    }));

    licenses.forEach(function (license) {
      form.append($("<input>", {
        type: "hidden",
        name: "licenses[]",
        value: license
      }));
    });

    form.append($("<input>", {
      type: "hidden",
      name: "format",
      value: format
    }));

    $("body").append(form);
    form.submit();
  }

  // Handle "Select All" checkbox toggle
  function bindSelectAllCheckbox() {
    $(document).on("change", "#select-all-checkbox", function () {
      const isChecked = $(this).is(":checked");
      $(".license-checkbox").prop("checked", isChecked);
    });
  }

  // Reset form UI after download
  function resetDownloadForm() {
    $("#bulk-download-format").val("");
    $(".license-checkbox").prop("checked", false);
    $("#select-all-checkbox").prop("checked", false);
  }
</script>





