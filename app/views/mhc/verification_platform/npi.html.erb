<div class="enc-content">
    <div class="container">
        <%= render "top_nav_buttons"%>

        <div class="mt-4 d-flex align-items-end justify-content-between gap-3">
            <div class="d-flex align-items-center gap-3">
                <h4 class="page-heading">NPI / NPPES</h4>
                <button class="btn btn-primary py-1">Edit</button>
            </div>
        </div>
        <div class="mt-2">
            <h6 class="form-heading">National Provider Identifier/National Plan and Provider Enumeration System</h6>
        </div>
        <div class="mt-2 page-applicable">
            <span class="page-note">
                <i class='bx bx-error-circle font-red'></i> <span>Please use the Registration tab to edit the
                    number.</span>
            </span>
            <span class="page-note">
                <i class='bx bx-error-circle font-red'></i> <span>Please use the Organization Info tab to edit the
                    number.</span>
            </span>
        </div>
        <div class="mt-2">
            <h6 class="form-heading">
            Website:
            <a href="https://npiregistry.cms.hhs.gov/" target="_blank">https://npiregistry.cms.hhs.gov/</a>
            </h6>
        </div>
        <%= form_for(@provider_personal_information, url: mhc_provider_personal_information_path(page_tab: 'npi')) do |f| %>
            <%= f.hidden_field :caqh_provider_attest_id %>
            <%= f.hidden_field :provider_attest_id %>
            <input type="hidden" id="page_tab" name="provider_personal_information[page_tab]" value=<%= params[:page_tab]%> />
            <div class="form-row row mt-2">
                <div class="col-xl-6">
                    <div class="form-row">
                        <label for="">Verification Result:</label>
                        <%= f.select :npi_verification_status, 
                          options_for_select([["Match", "match"], ["No Match", "no_match"], ["Possible Match", "possible_match"]], @provider_personal_information.npi_verification_status), 
                          {prompt: 'Select Option'}, 
                          { class: 'form-select border border-dark'} 
                        %>
                    </div>
                </div>
            </div>
            <div class="form-row row">
                  <div class="col-xl-6">
                    <div class="form-row">
                      <label for="">NPI Number (from Registration tab):</label>
                      <%= f.text_field :npi, placeholder: 'Type here...', class: 'form-control border border-dark', id: 'npi_input' %>
                    </div>
                  </div>
                <div class="col-xl-6">
                    <div class="form-row">
                        <label for="">NPI Number (from Organization Info tab):</label>
                        <input type="text" name="" id="" class="form-control" disabled>
                    </div>
                </div>
            </div>
            <div class="col-xl-6 mt-2">
              <button type="button" class="btn btn-info" id="verify_npi_button">Auto Rva</button>
            </div>
            <div class="form-row mt-2 d-flex justify-content-end">
               <%= f.submit 'Save', class: 'btn btn-primary', style: 'width: 200px;' %>
            </div>
        <% end %>
    </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const verifyButton = document.getElementById("verify_npi_button");
    const npiInput = document.getElementById("npi_input");

    // Check if handler already exists (prevent multiple bindings)
    if (verifyButton && !verifyButton.dataset.listenerAttached) {
      verifyButton.addEventListener("click", function (e) {
        e.preventDefault();
        console.log("üß™ Verify NPI Clicked");

        const npiNumber = npiInput.value.trim();

        if (!npiNumber) {
          alert("‚ö†Ô∏è Please enter an NPI number before verifying.");
          return;
        }

        fetch(`/mhc/verify_npi/${npiNumber}`)
          .then(response => response.json())
          .then(data => {
            if (data.status === "match") {
              alert("‚úÖ Match found for NPI Number.");
              document.querySelector("[name='provider_personal_information[npi_verification_status]']").value = "match";
            } else if (data.status === "no_match") {
              alert("‚ùå No match found.");
              document.querySelector("[name='provider_personal_information[npi_verification_status]']").value = "no_match";
            } else {
              alert("‚ö†Ô∏è An unexpected error occurred.");
            }
          })
          .catch(error => {
            console.error("Error during NPI lookup:", error);
            alert("‚ö†Ô∏è An error occurred while verifying NPI.");
          });
      });

      // Mark that we've attached the listener
      verifyButton.dataset.listenerAttached = "true";
    }
  });
</script>
