<script>
  $(document).ready(function(){
           // taxonomies
          $("#taxonomies").on("click", ".add_association", function() {
              var taxonomiesFields = $("#taxonomies .field");
              var newTaxonomy = taxonomiesFields.last().clone();
              var newId = new Date().getTime();
              newTaxonomy.html(newTaxonomy.html().replace(/taxonomies_attributes\]\[\d+\]/g, "taxonomies_attributes][" + newId + "]"));
              $("#taxonomies .fields").append(newTaxonomy);
          });

          // licenses
          let addLicensesCount = 0;
          $("#licenses").on("click", ".add_association", function() {
              var licensesFields = $("#licenses .field");
              var newLicense = licensesFields.last().clone();
              var newId = new Date().getTime();
              newLicense.html(newLicense.html().replace(/licenses_attributes\]\[\d+\]/g, "licenses_attributes][" + newId + "]"));
              $("#licenses .fields").append(newLicense);
              addLicensesCount += 1;

              newLicense.find('.remove-dynamic-fields').attr('data-id', addLicensesCount);
              newLicense.attr('data-id', addLicensesCount);
              $("#licenses .fields").append(newLicense);
          });

          $("#licenses").on("click", ".remove-dynamic-fields", function() {
            var field = document.getElementsByClassName("licenses-field");
            licenseField = $(this).attr("data-id");

            var licensesFields = $('.licenses-field[data-id='+licenseField+']');
            if(field.length > 1) {
              licensesFields.remove();
            }
          });

          // np licenses
          let addNpLicensesCount = 0;
          $("#np_licenses").on("click", ".add_association", function() {
              var npLicensesFields = $("#np_licenses .field");
              var newNpLicense = npLicensesFields.last().clone();
              var newId = new Date().getTime();
              newNpLicense.html(newNpLicense.html().replace(/np_licenses_attributes\]\[\d+\]/g, "np_licenses_attributes][" + newId + "]"));
              $("#np_licenses .fields").append(newNpLicense);
              addNpLicensesCount += 1;

              newNpLicense.find('.remove-dynamic-fields').attr('data-id', addNpLicensesCount);
              newNpLicense.attr('data-id', addNpLicensesCount);
              $("#np_licenses .fields").append(newNpLicense);
          });

          $("#np_licenses").on("click", ".remove-dynamic-fields", function() {
            var field = document.getElementsByClassName("np-licenses-field");
            npField = $(this).attr("data-id");

            var npLicensesFields = $('.np-licenses-field[data-id='+npField+']');
            if(field.length > 1) {
              npLicensesFields.remove();
            }
          });

          // rn licenses
          let addRnLicensesCount = 0;
          $("#rn_licenses").on("click", ".add_association", function() {
              var rnLicensesFields = $("#rn_licenses .field");
              var newRnLicense = rnLicensesFields.last().clone();
              var newId = new Date().getTime();
              newRnLicense.html(newRnLicense.html().replace(/rn_licenses_attributes\]\[\d+\]/g, "rn_licenses_attributes][" + newId + "]"));
              addRnLicensesCount += 1;

              newRnLicense.find('.remove-dynamic-fields').attr('data-id', addRnLicensesCount);
              newRnLicense.attr('data-id', addRnLicensesCount);
              $("#rn_licenses .fields").append(newRnLicense);
          });

          $("#rn_licenses").on("click", ".remove-dynamic-fields", function() {
            var field = document.getElementsByClassName("rn-licenses-field");
            rnField = $(this).attr("data-id");
            
            var rnLicensesFields = $('.rn-licenses-field[data-id='+rnField+']');
            if(field.length > 1) {
              rnLicensesFields.remove();
            }
          });

          // pa_licenses
          let addPaLicensesCount = 0;
          $("#pa_licenses").on("click", ".add_association", function() {
              var paLicensesFields = $("#pa_licenses .field");
              var newPaLicense = paLicensesFields.last().clone();
              var newId = new Date().getTime();
              newPaLicense.html(newPaLicense.html().replace(/pa_licenses_attributes\]\[\d+\]/g, "pa_licenses_attributes][" + newId + "]"));
              $("#np_licenses .fields").append(newPaLicense);
              addPaLicensesCount += 1;

              newPaLicense.find('.remove-dynamic-fields').attr('data-id', addPaLicensesCount);
              newPaLicense.attr('data-id', addPaLicensesCount);
              $("#pa_licenses .fields").append(newPaLicense);
          });

          $("#pa_licenses").on("click", ".remove-dynamic-fields", function() {
            var field = document.getElementsByClassName("pa-licenses-field");
            rnField = $(this).attr("data-id");
            
            var rnLicensesFields = $('.pa-licenses-field[data-id='+rnField+']');
            if(field.length > 1) {
              rnLicensesFields.remove();
            }
          });

          // dea_licenses
          let addDeaLicensesCount = 0;
          $("#dea_licenses").on("click", ".add_association", function() {
              var deaLicensesFields = $("#dea_licenses .field");
              var newDeaLicense = deaLicensesFields.last().clone();
              var newId = new Date().getTime();

              var dea_state_id = "provider_dea_licenses_attributes_" + newId + "_state_id";
              alert(dea_state_id);

              newDeaLicense.find("[id^='provider_dea_licenses_attributes_']").each(function() {
                var oldId = $(this).attr("id");
                var newIdValue = oldId.replace(/\d+/, newId);
                $(this).attr("id", newIdValue);
                $(this).attr("name", $(this).attr("name").replace(/\d+/, newId));
                $(this).val('');
              });

              newDeaLicense.html(newDeaLicense.html().replace(/dea_licenses_attributes\]\[\d+\]/g, "dea_licenses_attributes][" + newId + "]"));
              $("#np_licenses .fields").append(newDeaLicense);
              addDeaLicensesCount += 1;

              newDeaLicense.find('.remove-dynamic-fields').attr('data-id', addDeaLicensesCount);
              newDeaLicense.attr('data-id', addDeaLicensesCount);
              $("#dea_licenses .fields").append(newDeaLicense);


            setTimeout(function(){
              $.get('<%= provider_states_multi_select_data_path %>', function(data){
                 VirtualSelect.init({ele: '#' + dea_state_id, search: true });
                 document.querySelector('#' + dea_state_id).setOptions(data['result']);
                 document.querySelector('#' + dea_state_id).setValue(data['value']);
              });
           }, 500);

          });

          $("#dea_licenses").on("click", ".remove-dynamic-fields", function() {
            var field = document.getElementsByClassName("dea-licenses-field");
            deaField = $(this).attr("data-id");
            var rnLicensesFields = $('.dea-licenses-field[data-id='+deaField+']');
            if(field.length > 1) {
              rnLicensesFields.remove();
            }
          });

          // cnp_licences
          let addCnpLicensesCount = 0;
          $("#cnp_licenses").on("click", ".add_association", function() {
              var cnpLicensesFields = $("#cnp_licenses .field");
              var newCnpLicense = cnpLicensesFields.last().clone();
              var newId = new Date().getTime();
              newCnpLicense.html(newCnpLicense.html().replace(/cnp_licenses_attributes\]\[\d+\]/g, "cnp_licenses_attributes][" + newId + "]"));
              $("#np_licenses .fields").append(newCnpLicense);
              addCnpLicensesCount += 1;

              newCnpLicense.find('.remove-dynamic-fields').attr('data-id', addCnpLicensesCount);
              newCnpLicense.attr('data-id', addCnpLicensesCount);
              $("#cnp_licenses .fields").append(newCnpLicense);
          });

          $("#cnp_licenses").on("click", ".remove-dynamic-fields", function() {
            var field = document.getElementsByClassName("cnp-licenses-field");
            cnpField = $(this).attr("data-id");
            var cnpLicensesFields = $('.cnp-licenses-field[data-id='+cnpField+']');
            if(field.length > 1) {
              cnpLicensesFields.remove();
            }
          });

          // ins_policies
          let addInsPolicyCount = 0;
          $("#ins_policies").on("click", ".add_association", function() {
              var insPolicyFields = $("#ins_policies .field");
              var newInsPolicy = insPolicyFields.last().clone();
              var newId = new Date().getTime();
              newInsPolicy.html(newInsPolicy.html().replace(/ins_policies_attributes\]\[\d+\]/g, "ins_policies_attributes][" + newId + "]"));
              $("#np_licenses .fields").append(newInsPolicy);
              addInsPolicyCount += 1;

              newInsPolicy.find('.remove-dynamic-fields').attr('data-id', addInsPolicyCount);
              newInsPolicy.attr('data-id', addInsPolicyCount);
              $("#ins_policies .fields").append(newInsPolicy);
          });

          $("#ins_policies").on("click", ".remove-dynamic-fields", function() {
            var field = document.getElementsByClassName("ins-policy-field");
            insField = $(this).attr("data-id");
            
            var cnpLicensesFields = $('.ins-policy-field[data-id='+insField+']');
            if(field.length > 1) {
              cnpLicensesFields.remove();
            }
          });

          $(document).on("click", ".delete-license", function() {

              var model = $(this).data('model');
            var id = $(this).data('id');
            $(this).closest('.field').remove();
            $.ajax({
              url: '<%= delete_record_path %>',
              method: 'POST',
              data: { authenticity_token: csrfToken, model: model, id: id },
              success: function(data) {
                $(this).closest('.field').remove();

              }
            })
          });



          // telehealth providers
          $("#service_locations").on("click", ".add_association", function() {
              var serviceLocationsFields = $("#service_locations .field");
              var newServiceLocation = serviceLocationsFields.last().clone();
              var newId = new Date().getTime();
              newServiceLocation.html(newServiceLocation.html().replace(/service_locations_attributes\]\[\d+\]/g, "service_locations_attributes][" + newId + "]"));
              $("#service_locations .fields").append(newServiceLocation);

              var languageDropdown = $('[name="provider[service_locations_attributes]['+newId+'][primary_service_interpreter_language]]"]');
              languageDropdown.attr('id',("language_"+newId));
              setLanguages(languageDropdown.attr('id'));

              var statesDropdown = $('[name="provider[service_locations_attributes]['+newId+'][primary_service_telehealth_only_state]]"]');
              statesDropdown.attr('id',("states_"+newId));

              setStates(statesDropdown.attr('id'));
              var nonOfficeDropdown = $('[name="provider[service_locations_attributes]['+newId+'][primary_service_non_office_area]"]');
              nonOfficeDropdown.attr('id',("non_office_service_location_"+newId));

              setNonOfficeServiceLocation(nonOfficeDropdown.attr('id'));
              
          });

          $("#service_locations").on("click", ".remove-dynamic-fields", function() {
            var serviceLocationFields = document.getElementsByClassName("primary-service-location-field");
            if(serviceLocationFields.length > 1) {
              serviceLocationFields[0].remove();
            }
          });



      function setLanguages(dropdown_id) {
          var id = dropdown_id;
          $.ajax({
            url: '<%= get_languages_path %>',
            method: 'GET',
            data: { authenticity_token: csrfToken },
            success: function(data) {
              VirtualSelect.init({
                  options: data['languages'],
                  ele: '#'+id,
                  multiple: true,
              });
            }
          })
      }

      function setStates(dropdown_id) {
          var id = dropdown_id;
          $.ajax({
            url: '<%= get_states_path %>',
            method: 'GET',
            data: { authenticity_token: csrfToken },
            success: function(data) {
              VirtualSelect.init({
                  options: data['states'],
                  ele: '#'+id,
                  multiple: true,
              });
            }
          })
      }

      function setNonOfficeServiceLocation(dropdown_id) {
        var id = dropdown_id;
          $.ajax({
            url: '<%= get_states_with_id_path %>',
            method: 'GET',
            data: { authenticity_token: csrfToken },
            success: function(data) {
              VirtualSelect.init({
                  options: data['states'],
                  ele: '#'+id
              });
            }
          })
      }

      function setDeaStates(dropdown_id) {
        var id = dropdown_id;
          $.ajax({
            url: '<%= get_states_with_id_path %>',
            method: 'GET',
            data: { authenticity_token: csrfToken },
            success: function(data) {
              VirtualSelect.init({
                  options: data['states'],
                  ele: '#'+id
              });
            }
          })
      }
  })
</script>